<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Image Upload Demo</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 700px; margin:auto; }
    .preview { margin-top: 12px; display:flex; gap:12px; align-items:center; }
    .preview img { max-width:200px; max-height:200px; border:1px solid #ddd; padding:4px; }
    .progress-wrap { width:100%; background:#f3f3f3; border-radius:4px; height:10px; overflow:hidden; margin-top:8px; }
    .progress-bar { height:100%; width:0%; background:linear-gradient(90deg,#4caf50,#66bb6a); transition: width 0.1s; }
    .log { margin-top:8px; font-size:0.9em; color:#333; }
    button { padding:8px 14px; margin-left:8px; }
  </style>
</head>
<body>
  <h2>图片预览 + 上传（带进度）</h2>

  <input id="fileInput" type="file" accept="image/*" />
  <button id="uploadBtn" disabled>上传</button>

  <div class="preview" id="previewArea" style="display:none;">
    <div>
      <div>预览：</div>
      <img id="previewImg" src="" alt="preview" />
    </div>
    <div style="flex:1">
      <div>文件名: <span id="fileName"></span></div>
      <div>大小: <span id="fileSize"></span></div>
      <div class="progress-wrap" aria-hidden>
        <div id="progressBar" class="progress-bar"></div>
      </div>
      <div class="log" id="log"></div>
    </div>
  </div>

  <h3 style="margin-top:28px">已上传图片（可点击查看）</h3>
  <ul id="uploadedList"></ul>

  <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const previewArea = document.getElementById('previewArea');
    const previewImg = document.getElementById('previewImg');
    const fileNameEl = document.getElementById('fileName');
    const fileSizeEl = document.getElementById('fileSize');
    const progressBar = document.getElementById('progressBar');
    const log = document.getElementById('log');
    const uploadedList = document.getElementById('uploadedList');

    let selectedFile = null;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        previewArea.style.display = 'none';
        uploadBtn.disabled = true;
        return;
      }
      selectedFile = file;
      // 显示基本信息
      fileNameEl.textContent = file.name;
      fileSizeEl.textContent = (file.size / 1024).toFixed(1) + ' KB';
      previewArea.style.display = 'flex';
      uploadBtn.disabled = false;
      log.textContent = '';

      // 生成本地预览（FileReader）
      const reader = new FileReader();
      reader.onload = function(ev) {
        previewImg.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    uploadBtn.addEventListener('click', () => {
      if (!selectedFile) return;
      uploadBtn.disabled = true;
      uploadFileWithXHR(selectedFile);
    });

    function uploadFileWithXHR(file) {
      const url = '/upload'; // 后端上传接口
      const formData = new FormData();
      formData.append('file', file, file.name);

      const xhr = new XMLHttpRequest();

      xhr.open('POST', url, true);

      // 上传进度（浏览器事件）
      xhr.upload.onprogress = function(event) {
        if (event.lengthComputable) {
          const percent = (event.loaded / event.total) * 100;
          progressBar.style.width = percent + '%';
          log.textContent = `上传进度：${percent.toFixed(1)}%`;
        }
      };

      xhr.onload = function() {
        uploadBtn.disabled = false;
        if (xhr.status >= 200 && xhr.status < 300) {
          try {
            const resp = JSON.parse(xhr.responseText);
            if (resp.success) {
              log.textContent = '上传完成，fileId: ' + resp.fileId;
              // 把返回的 id 添加到已上传列表
              addUploadedItem(resp.fileId, file.name);
            } else {
              log.textContent = '上传失败: ' + (resp.message || 'unknown');
            }
          } catch (e) {
            log.textContent = '解析服务端返回失败';
          }
        } else {
          log.textContent = '上传失败，状态码：' + xhr.status;
        }
      };

      xhr.onerror = function() {
        uploadBtn.disabled = false;
        log.textContent = '网络错误，上传失败';
      };

      xhr.send(formData);
    }

    function addUploadedItem(id, filename) {
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = '/image/' + id;
      a.target = '_blank';
      a.textContent = filename + ' (查看)';
      li.appendChild(a);
      uploadedList.insertBefore(li, uploadedList.firstChild);
    }

    // 页面加载时获取已上传列表
    async function fetchList() {
      try {
        const res = await fetch('/list');
        if (!res.ok) return;
        const arr = await res.json();
        uploadedList.innerHTML = '';
        arr.forEach(item => {
          addUploadedItem(item.id, item.filename || item.id);
        });
      } catch (e) {
        console.warn('fetch list error', e);
      }
    }
    fetchList();
  </script>
</body>
</html>
