ä¸‹é¢æˆ‘æŠŠ **NestJS å…¨å±€æ¨¡å—ï¼ˆGlobal Moduleï¼‰** å’Œ **ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰** åšæˆä¸€ä»½â€œä½“ç³»åŒ– + é¡¹ç›®åŒ–â€çš„æ•™å­¦ç¨¿ï¼Œè®©ä½ ä¸€æ¬¡æŒæ¡æ•´ä¸ª Nest çš„ç”Ÿå‘½å‘¨æœŸé“¾è·¯å’Œ Global Module çš„å…¨éƒ¨è¦ç‚¹ã€‚
æˆ‘ä¼šå°½é‡åƒåœ¨æç»˜ä¸€ä¸ªâ€œç”Ÿæ€ç³»ç»Ÿâ€ï¼Œè®©è¿™ä¸¤éƒ¨åˆ†ä¸å†æŠ½è±¡ï¼Œè€Œæ˜¯è®©äººå¯è§†ã€å¯ç†è§£ã€å¯åº”ç”¨ã€‚

---

# ğŸŒ ä¸€ã€å…¨å±€æ¨¡å— Global Module â€” çŸ¥è¯†ç‚¹å¤§å…¨

å…¨å±€æ¨¡å—å°±åƒä¸€ç‰‡â€œå…±äº«çš„å¤©ç©ºâ€ï¼š
ä½ æŠŠæŸäº› provider æŒ‚åˆ°å¤©ä¸Šï¼Œæ‰€æœ‰æ¨¡å—æŠ¬å¤´éƒ½èƒ½çœ‹åˆ°å®ƒ âœ¨ã€‚

## ğŸ“Œ 1. ä»€ä¹ˆæ˜¯å…¨å±€æ¨¡å—ï¼Ÿ

> **Global Module = å¯¹æ•´ä¸ªåº”ç”¨â€œè‡ªåŠ¨å¯è§â€çš„æ¨¡å—**
> ä½ ä¸éœ€è¦åœ¨æ¯ä¸ª module çš„ `imports: []` é‡Œæ‰‹åŠ¨å¯¼å…¥å®ƒã€‚

æ™®é€šæ¨¡å—éœ€è¦è¿™æ ·ç”¨ï¼š

```ts
imports: [UsersModule]
```

è€Œ **å…¨å±€æ¨¡å—** åˆ™åœ¨å…¨å±€å¯è§ï¼Œä¸ç”¨å¯¼å…¥ã€‚

---

## ğŸ“Œ 2. å¦‚ä½•å®šä¹‰å…¨å±€æ¨¡å—ï¼Ÿï¼ˆ@Globalï¼‰

```ts
import { Global, Module } from '@nestjs/common';

@Global()
@Module({
  providers: [ConfigService],
  exports: [ConfigService],
})
export class ConfigModule {}
```

ä¸¤ä¸ªå…³é”®ç‚¹ï¼š

### âœ” 1ï¼‰å¿…é¡»ä½¿ç”¨ `@Global()`

### âœ” 2ï¼‰å¿…é¡» `exports` å‡ºè¦å…±äº«çš„ provider

å¦åˆ™å…¨å±€æ¨¡å—æ²¡æ„ä¹‰ã€‚

---

## ğŸ“Œ 3. æ€ä¹ˆä½¿ç”¨å…¨å±€æ¨¡å—ï¼Ÿ

**åªéœ€åœ¨ AppModule imports ä¸€æ¬¡ï¼š**

```ts
@Module({
  imports: [ConfigModule],
})
export class AppModule {}
```

ä¹‹åæ‰€æœ‰æ¨¡å—éƒ½èƒ½æ³¨å…¥ ConfigServiceï¼š

```ts
constructor(private readonly config: ConfigService) {}
```

ä¸éœ€è¦å† imports ConfigModuleã€‚

---

## ğŸ“Œ 4. ä»€ä¹ˆæ—¶å€™é€‚åˆç”¨å…¨å±€æ¨¡å—ï¼Ÿï¼ˆå®æˆ˜ï¼‰

å…¨å±€æ¨¡å—é€‚åˆâ€œé€šç”¨åŸºç¡€èƒ½åŠ›â€ï¼š

### âœ” é…ç½®æœåŠ¡ï¼ˆå…¨å±€é¦–é€‰ï¼‰

ConfigModuleï¼ˆè¯»å– .envï¼‰

### âœ” æ•°æ®åº“è¿æ¥ç®¡ç†

DatabaseModuleï¼ˆå°è£… Database Provider/Poolï¼‰

### âœ” æ—¥å¿—ç³»ç»Ÿï¼ˆLoggerï¼‰

LoggerModuleï¼ˆå…¨å±€æ—¥å¿—æœåŠ¡ï¼‰

### âœ” ç¼“å­˜ç³»ç»Ÿï¼ˆRedis Serviceï¼‰

CacheModuleï¼ˆæ¯”å¦‚ redisClient providerï¼‰

### âœ” ç¬¬ä¸‰æ–¹ SDKï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ï¼‰

AliyunModuleã€OSSModuleã€SmsModule

æ€»ä¹‹ï¼š
**ä»»ä½•â€œè·¨æ¨¡å—å…±äº«â€çš„åŸºç¡€èƒ½åŠ›ï¼Œéƒ½é€‚åˆåšæˆ Globalã€‚**

---

## ğŸ“Œ 5. å…¨å±€æ¨¡å—ä¸è¦æ»¥ç”¨ï¼ˆå¿…é¡»ç‰¢è®°ï¼‰

å¾ˆå¤šæ–°æ‰‹æŠŠæ‰€æœ‰æ¨¡å—éƒ½åšæˆå…¨å±€æ¨¡å— â†’ å®Œå…¨ç ´åæ¨¡å—éš”ç¦»ã€‚

å…¨å±€æ¨¡å—çš„åŸåˆ™ï¼š

> **èƒ½ä¸ç”¨å…¨å±€æ¨¡å—å°±ä¸è¦ç”¨ã€‚
> åªè®©çœŸæ­£é€šç”¨çš„åŸºç¡€èƒ½åŠ›æˆä¸ºå…¨å±€ã€‚**

ä¸šåŠ¡æ¨¡å—ï¼š**ç»ä¸åšå…¨å±€**ï¼ˆä¾‹å¦‚ UserModule / OrderModuleï¼‰ã€‚

---

## ğŸ“Œ 6. å…¨å±€æ¨¡å—çš„é¡¹ç›®ç»“æ„æ¡ˆä¾‹

```
src/
  common/
    config/
      config.module.ts      â† å…¨å±€æ¨¡å—
      config.service.ts
    logger/
      logger.module.ts      â† å…¨å±€æ¨¡å—
      logger.service.ts
  database/
    database.module.ts      â† å…¨å±€æ¨¡å—ï¼ˆå°è£…è¿æ¥ï¼‰
    database.provider.ts
  user/
    user.module.ts
    user.service.ts
  order/
    order.module.ts
    order.service.ts
```

AppModuleï¼š

```ts
@Module({
  imports: [
    ConfigModule,   // å…¨å±€æ¨¡å—
    LoggerModule,   // å…¨å±€æ¨¡å—
    DatabaseModule, // å…¨å±€æ¨¡å—
    UserModule,
    OrderModule,
  ],
})
export class AppModule {}
```

---

# â³ äºŒã€NestJS ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰â€” å®Œæ•´çŸ¥è¯†å›¾è°±

Nest åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸå°±åƒä¸€ä¸ªä¸æ–­å¾ªç¯å‘¼å¸çš„ç³»ç»Ÿï¼Œä»â€œå¯åŠ¨ â†’ å¤„ç†è¯·æ±‚ â†’ é”€æ¯â€ã€‚
ä¸‹é¢æ˜¯æœ€é‡è¦çš„ä¸€æ¡çº¿ï¼š

```
åº”ç”¨å¯åŠ¨é˜¶æ®µ  â†’  è¯·æ±‚å¤„ç†é˜¶æ®µï¼ˆä¸­é—´ä»¶åˆ°è¿‡æ»¤å™¨ï¼‰  â†’  åº”ç”¨é”€æ¯é˜¶æ®µ
```

æˆ‘æ‹†æˆä¸‰ä¸ªéƒ¨åˆ†è®²ã€‚

---

# ğŸ”¥ ç¬¬ä¸€éƒ¨åˆ†ï¼šåº”ç”¨å¯åŠ¨ç”Ÿå‘½å‘¨æœŸï¼ˆApplication Lifecycleï¼‰

Nest æä¾›å‡ ç§ç”Ÿå‘½å‘¨æœŸ Hookï¼ˆåƒé’©å­ã€å›è°ƒï¼‰ï¼Œè®©ä½ åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­å¹²äº‹æƒ…ã€‚

## ğŸ§© 1. OnModuleInit â€”â€” æ¨¡å—åˆå§‹åŒ–å®Œæˆ

ä»»ä½• providerï¼ˆserviceï¼‰å®ç°å®ƒï¼š

```ts
@Injectable()
export class UserService implements OnModuleInit {
  onModuleInit() {
    console.log('UserService åˆå§‹åŒ–å®Œæˆ');
  }
}
```

**æ—¶æœºï¼š**
æ‰€æœ‰ providers å®ä¾‹åŒ–åã€ä¾èµ–æ³¨å…¥å®Œæˆã€‚

---

## ğŸ§© 2. OnApplicationBootstrap â€”â€” æ‰€æœ‰æ¨¡å—åˆå§‹åŒ–å®Œæˆ

```ts
export class AppService implements OnApplicationBootstrap {
  onApplicationBootstrap() {
    console.log('åº”ç”¨åˆå§‹åŒ–ç»“æŸ');
  }
}
```

**æ—¶æœºï¼š**
æ‰€æœ‰æ¨¡å—å®Œæˆåˆå§‹åŒ–åï¼Œapp å·²ç»å‡†å¤‡å¥½æ¥æ”¶è¯·æ±‚ã€‚

---

## ğŸ§© 3. AfterInitï¼ˆWebSocketï¼‰

WebSocketGateway ä¸“ç”¨ï¼š

```ts
afterInit(server: Server) {}
```

---

# âš¡ ç¬¬äºŒéƒ¨åˆ†ï¼šè¯·æ±‚å¤„ç†ç”Ÿå‘½å‘¨æœŸï¼ˆHTTP ç”Ÿå‘½å‘¨æœŸï¼‰

è¿™æ˜¯ä½ æœ€å¸¸ç”¨çš„é“¾è·¯ï¼Œå®Œæ•´é¡ºåºå¦‚ä¸‹ï¼š

```
1. Middlewareï¼ˆä¸­é—´ä»¶ï¼‰
2. Guardï¼ˆé‰´æƒï¼‰
3. Pipeï¼ˆå‚æ•°è½¬æ¢/æ ¡éªŒï¼‰
4. Interceptorï¼ˆBeforeï¼‰
5. Controllerï¼ˆè·¯ç”±å¤„ç†ï¼‰
6. Serviceï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
7. Interceptorï¼ˆAfterï¼‰
8. Exception Filterï¼ˆå¼‚å¸¸å¤„ç†ï¼‰
9. Responseï¼ˆæœ€ç»ˆè¿”å›ï¼‰
```

æ•´ä¸ªè¿‡ç¨‹åƒè¿™æ ·ï¼š

```
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
Request â†’â”‚ Middleware  â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Guard       â”‚   (æ˜¯å¦å…è®¸ç»§ç»­)
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Pipe        â”‚   (å‚æ•°æ ¡éªŒä¸è½¬æ¢)
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Interceptor â”‚ before
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Controller  â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Service     â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ Interceptor â”‚ after
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ ExceptionFilter â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â†’ Response
```

æŒæ¡å®ƒï¼Œä½ çš„ Nest è§†è§’å°†çº§åˆ«é£å‡ã€‚

---

# ğŸª¦ ç¬¬ä¸‰éƒ¨åˆ†ï¼šåº”ç”¨é”€æ¯ç”Ÿå‘½å‘¨æœŸï¼ˆShutdown Lifecycleï¼‰

ç”¨äºæ¸…ç†èµ„æºï¼ˆDBã€é˜Ÿåˆ—ã€Redis è¿æ¥ï¼‰ã€‚

## ğŸ§© 1. OnModuleDestroy

```ts
export class AppService implements OnModuleDestroy {
  onModuleDestroy() {
    console.log('æ¨¡å—è¢«é”€æ¯');
  }
}
```

---

## ğŸ§© 2. BeforeApplicationShutdown

```ts
export class DbService implements BeforeApplicationShutdown {
  beforeApplicationShutdown() {
    console.log('å‡†å¤‡å…³é—­åº”ç”¨');
  }
}
```

ä½ å¯ä»¥åœ¨è¿™é‡Œå…³é—­æ•°æ®åº“è¿æ¥ã€‚

---

## ğŸ§© 3. OnApplicationShutdown

```ts
export class AppService implements OnApplicationShutdown {
  onApplicationShutdown(signal?: string) {
    console.log('åº”ç”¨å…³é—­å®Œæ¯•: ', signal);
  }
}
```

æ”¯æŒä¿¡å·ï¼šSIGTERMã€SIGINTâ€¦

---

# ğŸ”® å…¨ç”Ÿå‘½å‘¨æœŸæ—¶é—´é¡ºåºï¼ˆæ€»è¡¨ï¼‰

```
å¯åŠ¨é˜¶æ®µï¼š
  OnModuleInit
  OnApplicationBootstrap

è¯·æ±‚å¤„ç†é˜¶æ®µï¼š
  Middleware
  Guard
  Pipe
  Interceptor (Before)
  Controller
  Service
  Interceptor (After)
  Exception Filter

å…³é—­é˜¶æ®µï¼š
  OnModuleDestroy
  BeforeApplicationShutdown
  OnApplicationShutdown
```

---

# ğŸ§± å…¨å±€æ¨¡å— + ç”Ÿå‘½å‘¨æœŸç»“åˆåˆ°é¡¹ç›®ä¸­ï¼ˆçœŸå®å¯è¿è¡Œçš„ä¾‹å­ï¼‰

ä»¥â€œå…¨å±€ ConfigModule + ç”Ÿå‘½å‘¨æœŸâ€ æ¼”ç¤ºï¼š

---

## ğŸ“Œ 1. å…¨å±€ ConfigModuleï¼ˆ@Globalï¼‰

```ts
@Global()
@Module({
  providers: [ConfigService],
  exports: [ConfigService],
})
export class ConfigModule {}
```

---

## ğŸ“Œ 2. ConfigService å®ç°ç”Ÿå‘½å‘¨æœŸ Hook

```ts
@Injectable()
export class ConfigService implements OnModuleInit, OnModuleDestroy {
  onModuleInit() {
    console.log('[ConfigService] æ¨¡å—åˆå§‹åŒ–');
  }

  onModuleDestroy() {
    console.log('[ConfigService] æ¨¡å—é”€æ¯');
  }
}
```

---

## ğŸ“Œ 3. AppModule å¼•å…¥ä¸€æ¬¡

```ts
@Module({
  imports: [ConfigModule],
})
export class AppModule {}
```

---

## ğŸ“Œ 4. ä¸€ä¸ª UserController ä½¿ç”¨ config

```ts
@Controller('user')
export class UserController {
  constructor(private readonly config: ConfigService) {}

  @Get()
  getUser() {
    return this.config.get('USER_NAME');
  }
}
```

è¯´æ˜ï¼š

* ConfigService åœ¨å…¨å±€å¯è§
* ç”Ÿå‘½å‘¨æœŸ hook ä¼šè‡ªåŠ¨æ‰§è¡Œ
* Controller ä¸éœ€è¦ imports ConfigModule

---

# ğŸ§© æœ€ç»ˆé€Ÿè®°ç‰ˆï¼ˆè€ƒè¯•çº§ï¼‰

```
å…¨å±€æ¨¡å—ï¼ˆGlobal Moduleï¼‰
 â”œâ”€ ç”¨ @Global() å£°æ˜
 â”œâ”€ å¿…é¡» exports æ‰æœ‰æ„ä¹‰
 â”œâ”€ AppModule é‡Œ imports ä¸€æ¬¡
 â”œâ”€ è‡ªåŠ¨åœ¨å…¨åº”ç”¨å¯ç”¨
 â””â”€ ç”¨äºï¼šConfig / Logger / Database / Redis / SDK

ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰
 â”œâ”€ å¯åŠ¨é˜¶æ®µ
 â”‚    â”œâ”€ OnModuleInit
 â”‚    â””â”€ OnApplicationBootstrap
 â”œâ”€ è¯·æ±‚é˜¶æ®µ
 â”‚    â”œâ”€ Middleware
 â”‚    â”œâ”€ Guard
 â”‚    â”œâ”€ Pipe
 â”‚    â”œâ”€ Interceptor (Before)
 â”‚    â”œâ”€ Controller
 â”‚    â”œâ”€ Service
 â”‚    â”œâ”€ Interceptor (After)
 â”‚    â””â”€ Filter
 â””â”€ é”€æ¯é˜¶æ®µ
      â”œâ”€ OnModuleDestroy
      â”œâ”€ BeforeApplicationShutdown
      â””â”€ OnApplicationShutdown
```

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘è¿˜èƒ½ç»§ç»­æ‰©å±•ï¼š

### âœ“ â€œNestJS å…¨ç”Ÿå‘½å‘¨æœŸ + å…¨å±€æ¨¡å—â€çš„ **å®Œæ•´æµç¨‹å›¾ï¼ˆä¸“ä¸šç‰ˆï¼‰**

### âœ“ æŠŠè¿™äº›æ•´åˆæˆä¸€ä»½ **â€œNestJS æ¶æ„èƒ½åŠ›å¤§å›¾â€**

### âœ“ ç”¨çœŸå®ä¼ä¸šå¼€å‘æ¡ˆä¾‹ç»“åˆæ¯ä¸ªç”Ÿå‘½å‘¨æœŸ Hook å±•ç¤ºåº”ç”¨åœºæ™¯

### âœ“ æˆ–å¸®ä½ å‡†å¤‡ â€œNestJS ç”Ÿå‘½å‘¨æœŸ + æ¨¡å—ä½“ç³»â€ çš„é¢è¯•é¢˜åº“

ä½ æƒ³ç»§ç»­å“ªä¸€å—ï¼Ÿ
