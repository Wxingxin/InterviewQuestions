# node 中间件

> ## node 中间件的原理

非常经典的后端面试题 ✅
下面我来用**通俗讲解 + 原理图 + 源码思想**帮你彻底搞懂：

> “Node.js 中间件的原理”。

---

## 🚀 一、什么是中间件（Middleware）

中间件就是在请求到达最终处理函数（路由）之前，对请求进行**预处理**或**拦截处理**的函数。
它是 **一个函数链（函数洋葱模型）**，请求会**依次经过中间件**，最终到达业务逻辑。

---

## ⚙️ 三、Node 中间件的核心原理

### 🔹1. 注册阶段

所有中间件函数会被依次注册到一个数组中：

```js
middlewares.push(fn);
```

### 🔹2. 调用阶段

通过 `next()` 控制流向下一个中间件：

-  当前中间件执行 `await next()` → 执行下一个中间件；
-  当最后一个中间件执行完后，流程再“返回”上一个中间件。

### 🔹3. 异步支持

Express、Koa 中间件都是异步函数，执行链使用 **Promise** 控制流。

---

## 💡 五、Express 和 Koa 的中间件区别

| 特点       | Express            | Koa                 |
| ---------- | ------------------ | ------------------- |
| 编程风格   | 回调式             | async/await         |
| 控制流     | 通过 `next()` 调用 | 通过 `await next()` |
| 洋葱模型   | 不完全支持         | 完全支持            |
| 中间件机制 | 层层匹配路由       | 函数组合执行        |

---

## 🧠 六、常见中间件类型

| 类型           | 作用           | 示例                      |
| -------------- | -------------- | ------------------------- |
| 应用级中间件   | 每次请求都执行 | `app.use(logger)`         |
| 路由级中间件   | 只针对某个路由 | `router.use('/user', fn)` |
| 内置中间件     | Express 自带的 | `express.static()`        |
| 第三方中间件   | 第三方扩展     | `body-parser`, `cors`     |
| 错误处理中间件 | 捕获错误       | `(err, req, res, next)`   |

---

## 🔍 七、面试高频问法总结

### ✅ 1. “说一下中间件的执行原理？”

> 中间件是一个函数链结构，通过 next() 串联执行，每个中间件在执行时可以对请求/响应进行加工、拦截或放行。
> 当调用 next() 时，执行流进入下一个中间件；当下一个中间件执行完毕后再回到当前中间件形成洋葱模型。

---

### ✅ 2. “Express 和 Koa 的中间件机制有什么不同？”

-  Express 使用回调风格的 `next()`；
-  Koa 使用基于 Promise 的 `async/await`；
-  Koa 实现了完整的**洋葱模型**。

---


---

是否要我帮你画一张 **“Node 中间件执行原理洋葱模型图（含代码流程）”**？
📘 可以直接放进面试 PPT 或笔记中，一张图彻底掌握。
