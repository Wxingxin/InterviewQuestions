> # Commonjs

> ### ğŸ§  ä¸€ã€CommonJS çš„è®¤è¯†
1. æ˜¯ä»€ä¹ˆ
**CommonJS** æ˜¯ä¸€ç§æ¨¡å—åŒ–è§„èŒƒï¼Œæœ€æ—©ç”¨äº Node.jsã€‚
æ¯ä¸ªæ–‡ä»¶å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹æ¨¡å—ï¼Œæ¨¡å—ä¹‹é—´é€šè¿‡ï¼š

* `module.exports` / `exports` å¯¼å‡º
* `require()` å¯¼å…¥

ç‰¹ç‚¹ï¼š

* **åŒæ­¥åŠ è½½**ï¼ˆé€‚åˆåç«¯ï¼‰
* **è¿è¡Œæ—¶åŠ è½½**
* **æ¯ä¸ªæ¨¡å—åªä¼šæ‰§è¡Œä¸€æ¬¡ï¼ˆæœ‰ç¼“å­˜ï¼‰**

2. æ¨¡å—æœ‰ä¸¤ä¸ªæ ¸å¿ƒè¦ç´ ï¼š**éšè—å’Œæš´éœ²**

- éšè—çš„ï¼Œæ˜¯è‡ªå·±å†…éƒ¨çš„å®ç°
- æš´éœ²çš„ï¼Œæ˜¯å¸Œæœ›å¤–éƒ¨ä½¿ç”¨çš„æ¥å£
- ä»»ä½•ä¸€ä¸ªæ­£å¸¸çš„æ¨¡å—åŒ–æ ‡å‡†ï¼Œéƒ½åº”è¯¥é»˜è®¤éšè—æ¨¡å—ä¸­çš„æ‰€æœ‰å®ç°ï¼Œè€Œé€šè¿‡ä¸€äº›è¯­æ³•æˆ–apiè°ƒç”¨æ¥æš´éœ²æ¥å£
- æš´éœ²æ¥å£çš„è¿‡ç¨‹å³æ¨¡å—çš„å¯¼å‡º

---


### å¯¼å‡ºå•ä¸ªå¯¹è±¡ï¼ˆæœ€å¸¸ç”¨ï¼‰

```js
// math.js
module.exports = {
  add(a, b) {
    return a + b;
  },
  sub(a, b) {
    return a - b;
  }
};
```

å¯¼å…¥ï¼š

```js
const math = require('./math');
console.log(math.add(1, 2)); // 3
```

---

### å¯¼å‡ºå•ä¸ªå‡½æ•° / ç±»

```js
// say.js
module.exports = function(name) {
  console.log('Hello ' + name);
};
```

å¯¼å…¥ï¼š

```js
const say = require('./say');
say('Alice');
```

---

### â‘¢ ä½¿ç”¨ `exports` ç®€å†™

> æ³¨æ„ï¼š`exports` åªæ˜¯ `module.exports` çš„**å¼•ç”¨**ã€‚

```js
// utils.js
exports.add = (a, b) => a + b;
exports.mul = (a, b) => a * b;
```

å¯¼å…¥ï¼š

```js
const { add, mul } = require('./utils');
console.log(add(2, 3)); // 5
```

âš ï¸ **æ³¨æ„å‘ç‚¹ï¼š**

```js
// âŒ è¿™æ ·ä¼šæ–­å¼€ exports å¼•ç”¨ï¼š
exports = { a: 1 }; // æ— æ•ˆ
// âœ… æ­£ç¡®ï¼š
module.exports = { a: 1 };
```

---

## ğŸ§© ä¸‰ã€å¯¼å…¥æ–¹æ³•å¤§å…¨ï¼ˆ`require`ï¼‰

| ç”¨æ³•      | è¯´æ˜            | ç¤ºä¾‹                                                       |
| ------- | ------------- | -------------------------------------------------------- |
| å¯¼å…¥å¯¹è±¡    | é»˜è®¤æ–¹å¼          | `const mod = require('./mod');`                          |
| è§£æ„å¯¼å…¥    | æŒ‰å±æ€§å–å€¼         | `const { add } = require('./math');`                     |
| åŠ¨æ€å¯¼å…¥    | æ¡ä»¶åŠ è½½          | `const db = require(isProd ? './db.prod' : './db.dev');` |
| æ ¸å¿ƒæ¨¡å—    | Node å†…ç½®æ¨¡å—     | `const fs = require('fs');`                              |
| ç¬¬ä¸‰æ–¹æ¨¡å—   | npm åŒ…         | `const express = require('express');`                    |
| JSON æ–‡ä»¶ | è‡ªåŠ¨è§£æä¸ºå¯¹è±¡       | `const data = require('./data.json');`                   |
| ç›®å½•æ¨¡å—    | é»˜è®¤åŠ è½½ index.js | `const api = require('./api');`ï¼ˆä¼šåŠ è½½ `api/index.js`ï¼‰      |

---

## âš™ï¸ å››ã€æ¨¡å—ç¼“å­˜æœºåˆ¶

CommonJS æ¨¡å—åªåŠ è½½ä¸€æ¬¡ï¼š

```js
// a.js
console.log('æ¨¡å—æ‰§è¡Œ');

// b.js
require('./a');
require('./a'); // ä¸ä¼šå†æ¬¡æ‰§è¡Œ
```

è¾“å‡ºï¼š

```
æ¨¡å—æ‰§è¡Œ
```

> âœ… Node.js ä¼šç¼“å­˜åŠ è½½è¿‡çš„æ¨¡å—å¯¹è±¡ï¼ˆå­˜äº `require.cache`ï¼‰ã€‚

å¯æ¸…é™¤ç¼“å­˜ï¼š

```js
delete require.cache[require.resolve('./a')];
```

---

## ğŸ§± äº”ã€æ¨¡å—çš„æ‰§è¡Œç¯å¢ƒ

æ¯ä¸ª CommonJS æ¨¡å—å†…éƒ¨éƒ½è¢«åŒ…è£¹åœ¨ä¸€ä¸ªå‡½æ•°ä¸­ï¼š

```js
(function(exports, require, module, __filename, __dirname) {
  // æ¨¡å—ä»£ç åœ¨è¿™é‡Œ
});
```

å› æ­¤åœ¨æ¨¡å—ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

* `__dirname`ï¼šå½“å‰æ–‡ä»¶æ‰€åœ¨ç›®å½•
* `__filename`ï¼šå½“å‰æ–‡ä»¶ç»å¯¹è·¯å¾„
* `module`ï¼šå½“å‰æ¨¡å—å¯¹è±¡
* `exports`ï¼šå¯¼å‡ºå¯¹è±¡

---

## ğŸš€ å…­ã€ç»å…¸é¡¹ç›®å®æˆ˜ç¤ºä¾‹

### â‘  æ‹†åˆ†å·¥å…·æ¨¡å—

```js
// lib/string.js
exports.capitalize = str => str[0].toUpperCase() + str.slice(1);
exports.lowercase = str => str.toLowerCase();
```

```js
// index.js
const { capitalize } = require('./lib/string');
console.log(capitalize('hello')); // Hello
```

---

### â‘¡ å¯¼å‡ºé…ç½®æ–‡ä»¶

```js
// config.js
module.exports = {
  port: 8080,
  db: 'mongodb://localhost:27017/test'
};
```

```js
// app.js
const config = require('./config');
console.log(config.port); // 8080
```

---

### â‘¢ å¯¼å‡ºç±»

```js
// user.js
class User {
  constructor(name) { this.name = name; }
  say() { console.log(`Hi, I'm ${this.name}`); }
}
module.exports = User;
```

```js
const User = require('./user');
const u = new User('Alice');
u.say(); // Hi, I'm Alice
```

---

## ğŸ”„ ä¸ƒã€CommonJS vs ES Module å¯¹æ¯”

| ç‰¹ç‚¹   | CommonJS                   | ES Module            |
| ---- | -------------------------- | -------------------- |
| è¯­æ³•   | `require / module.exports` | `import / export`    |
| åŠ è½½   | åŒæ­¥åŠ è½½                       | å¼‚æ­¥åŠ è½½                 |
| ä½¿ç”¨åœºæ™¯ | Node.js ç¯å¢ƒ                 | æµè§ˆå™¨ã€Node.js(ESMæ”¯æŒ)   |
| ç¼“å­˜   | æœ‰ç¼“å­˜                        | æœ‰ç¼“å­˜                  |
| å¯¼å…¥è·¯å¾„ | å¯ä»¥åŠ¨æ€                       | å¿…é¡»é™æ€                 |
| é»˜è®¤å¯¼å‡º | `module.exports = ...`     | `export default ...` |

---

## ğŸ§© å…«ã€æ··ç”¨æŠ€å·§ï¼ˆåœ¨ Node.js ä¸­ï¼‰

å¦‚æœä½ ç”¨çš„æ˜¯ Node.jsï¼ˆæ”¯æŒ ESM çš„ç‰ˆæœ¬ï¼‰ï¼Œä¸¤ç§å†™æ³•å¯ä»¥äº’æ“ä½œï¼š

```js
// CommonJS å¯¼å‡º
module.exports = { name: 'TS' };

// åœ¨ ES Module ä¸­å¯¼å…¥ï¼š
import pkg from './mod.cjs';
console.log(pkg.name);
```

---

æ˜¯å¦å¸Œæœ›æˆ‘æ¥ç€ä¸ºä½ å†™ä¸€ä»½ï¼š

> ğŸ§­ã€ŒCommonJS + ESModule å¯¹æ¯”ä½¿ç”¨å¤§å…¨ + äº’è½¬å®æˆ˜ç¤ºä¾‹ã€
> åŒ…æ‹¬å¦‚ä½•æŠŠ CommonJS å†™æ³•æ”¹æˆ ESModule å†™æ³•ï¼Ÿ
# esmodele

éå¸¸æ£’ ğŸ‘
ä½ ç°åœ¨è¦ç³»ç»ŸæŒæ¡ **ES Moduleï¼ˆESMï¼‰** çš„ä½¿ç”¨æ–¹æ³•å¤§å…¨ï¼Œè¿™éƒ¨åˆ†æ˜¯å‰ç«¯å’Œ Node.js é¢è¯•ä¸­çš„é‡ç‚¹è€ƒç‚¹ä¹‹ä¸€ï¼Œå°¤å…¶æ˜¯å’Œ CommonJS å¯¹æ¯”æ—¶ç»å¸¸è¢«é—®åˆ°ã€‚

æˆ‘ä¼šåˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªéƒ¨åˆ†å¸®ä½ å½»åº•æŒæ¡ ğŸ‘‡

> ğŸ“š ä¸€ã€ES Module æ˜¯ä»€ä¹ˆ
> ğŸ“¦ äºŒã€å¯¼å‡ºæ–¹å¼å¤§å…¨
> ğŸ“¥ ä¸‰ã€å¯¼å…¥æ–¹å¼å¤§å…¨
> âš™ï¸ å››ã€åŠ¨æ€å¯¼å…¥
> ğŸ§  äº”ã€æ¨¡å—ä½œç”¨åŸŸä¸åªæ‰§è¡Œä¸€æ¬¡
> ğŸš€ å…­ã€ç»å…¸å®æˆ˜æ¡ˆä¾‹
> ğŸ”„ ä¸ƒã€ä¸ CommonJS çš„åŒºåˆ«
> ğŸ’¡ å…«ã€Node.js ä¸­çš„ä½¿ç”¨æ–¹æ³•

---

## ğŸ“š ä¸€ã€ES Module æ˜¯ä»€ä¹ˆï¼Ÿ

**ES Moduleï¼ˆESMï¼‰** æ˜¯ ES6 å¼•å…¥çš„å®˜æ–¹æ¨¡å—åŒ–æ ‡å‡†ã€‚
æ¯ä¸ªæ–‡ä»¶éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹æ¨¡å—ï¼Œé€šè¿‡ï¼š

* `export` å¯¼å‡º
* `import` å¯¼å…¥

âœ… ç‰¹ç‚¹ï¼š

* é™æ€åˆ†æï¼ˆç¼–è¯‘æ—¶ç¡®å®šä¾èµ–ï¼‰
* å¼‚æ­¥åŠ è½½ï¼ˆæµè§ˆå™¨ä¸­éé˜»å¡ï¼‰
* åªåŠ è½½ä¸€æ¬¡ï¼ˆæœ‰ç¼“å­˜ï¼‰
* æ”¯æŒ tree-shakingï¼ˆç¼–è¯‘æ—¶ä¼˜åŒ–ï¼‰

---

## ğŸ“¦ äºŒã€å¯¼å‡ºæ–¹å¼å¤§å…¨ï¼ˆ`export`ï¼‰

### â‘  **å‘½åå¯¼å‡º**ï¼ˆNamed Exportï¼‰

```js
// math.js
export const PI = 3.14159;
export function add(a, b) {
  return a + b;
}
export class Calculator {
  multiply(a, b) { return a * b; }
}
```

å¯¼å…¥ï¼š

```js
import { PI, add, Calculator } from './math.js';
console.log(add(1, 2)); // 3
```

åˆ«åå¯¼å‡ºï¼š

```js
export { add as plus };
```

å¯¼å…¥ï¼š

```js
import { plus } from './math.js';
```

---

### â‘¡ **ç»Ÿä¸€å¯¼å‡º**

```js
const name = 'Tom';
const age = 18;
function greet() { console.log('Hi'); }

export { name, age, greet };
```

---

### â‘¢ **é»˜è®¤å¯¼å‡º**ï¼ˆDefault Exportï¼‰

> æ¯ä¸ªæ¨¡å—åªèƒ½æœ‰ä¸€ä¸ªé»˜è®¤å¯¼å‡ºã€‚

```js
// user.js
export default function sayHi(name) {
  console.log(`Hi, ${name}`);
}
```

å¯¼å…¥ï¼š

```js
import sayHi from './user.js';
sayHi('Alice');
```

âœ… é»˜è®¤å¯¼å‡ºå¯¼å…¥æ—¶å¯ä»¥éšæ„å‘½åï¼š

```js
import hi from './user.js';
```

---

### â‘£ **é»˜è®¤å¯¼å‡º + å‘½åå¯¼å‡ºå¹¶å­˜**

```js
// config.js
export default { port: 8080 };
export const VERSION = '1.0.0';
```

å¯¼å…¥ï¼š

```js
import config, { VERSION } from './config.js';
```

---

## ğŸ“¥ ä¸‰ã€å¯¼å…¥æ–¹å¼å¤§å…¨ï¼ˆ`import`ï¼‰

### â‘  å¯¼å…¥å‘½åå¯¼å‡º

```js
import { add, PI } from './math.js';
```

### â‘¡ å¯¼å…¥é»˜è®¤å¯¼å‡º

```js
import add from './math.js';
```

### â‘¢ å¯¼å…¥æ‰€æœ‰æˆå‘˜ï¼ˆå‘½åç©ºé—´å¯¼å…¥ï¼‰

```js
import * as math from './math.js';
console.log(math.PI);
```

### â‘£ å¯¼å…¥å¹¶é‡å‘½å

```js
import { add as plus } from './math.js';
```

### â‘¤ åªå¯¼å…¥æ¨¡å—æ‰§è¡Œï¼ˆä¸å–å€¼ï¼‰

```js
import './init.js';
```

---

## âš™ï¸ å››ã€åŠ¨æ€å¯¼å…¥ï¼ˆ`import()`ï¼‰

ESM ä¹Ÿæ”¯æŒåŠ¨æ€å¯¼å…¥ï¼ˆè¿”å› Promiseï¼‰ï¼š

```js
if (needMath) {
  const math = await import('./math.js');
  console.log(math.add(2, 3));
}
```

åŠ¨æ€å¯¼å…¥å¸¸ç”¨äºï¼š

* æ‡’åŠ è½½
* æŒ‰éœ€åŠ è½½
* æ¡ä»¶åŠ è½½æ¨¡å—

---

## ğŸ§  äº”ã€æ¨¡å—ä½œç”¨åŸŸä¸åªæ‰§è¡Œä¸€æ¬¡

æ¯ä¸ªæ¨¡å—éƒ½æœ‰ç‹¬ç«‹ä½œç”¨åŸŸï¼š

```js
// a.js
let count = 0;
export function inc() { count++; console.log(count); }
```

```js
// b.js
import { inc } from './a.js';
inc(); // 1
inc(); // 2

// c.js
import { inc } from './a.js';
inc(); // 3
```

> âœ… å³ä½¿ä»ä¸åŒæ–‡ä»¶å¯¼å…¥åŒä¸€ä¸ªæ¨¡å—ï¼Œä¹Ÿåªä¼šæ‰§è¡Œä¸€æ¬¡ã€‚

---

## ğŸš€ å…­ã€ç»å…¸å®æˆ˜æ¡ˆä¾‹

### â‘  æ‹†åˆ†å·¥å…·æ¨¡å—

```js
// utils/string.js
export function capitalize(str) {
  return str[0].toUpperCase() + str.slice(1);
}
```

```js
// app.js
import { capitalize } from './utils/string.js';
console.log(capitalize('hello')); // Hello
```

---

### â‘¡ é»˜è®¤å¯¼å‡ºé…ç½®

```js
// config.js
export default {
  baseURL: 'https://api.example.com',
  timeout: 3000
};
```

```js
import config from './config.js';
console.log(config.baseURL);
```

---

### â‘¢ ç»„åˆå¯¼å‡ºï¼ˆæ¨¡å—èšåˆï¼‰

```js
// math.js
export const add = (a, b) => a + b;
export const sub = (a, b) => a - b;

// index.js
export * from './math.js';
export { default as config } from './config.js';
```

```js
import { add, sub, config } from './index.js';
```

---

## ğŸ”„ ä¸ƒã€ES Module vs CommonJS å¯¹æ¯”

| å¯¹æ¯”é¡¹               | ES Module                   | CommonJS                     |
| ----------------- | --------------------------- | ---------------------------- |
| å¯¼å‡ºè¯­æ³•              | `export` / `export default` | `module.exports` / `exports` |
| å¯¼å…¥è¯­æ³•              | `import`                    | `require()`                  |
| åŠ è½½æ—¶æœº              | ç¼–è¯‘æ—¶é™æ€åŠ è½½                     | è¿è¡Œæ—¶åŠ¨æ€åŠ è½½                      |
| æ˜¯å¦å¼‚æ­¥              | âœ… å¼‚æ­¥åŠ è½½ï¼ˆæµè§ˆå™¨ï¼‰                 | âŒ åŒæ­¥åŠ è½½                       |
| this æŒ‡å‘           | `undefined`                 | å½“å‰æ¨¡å—å¯¹è±¡                       |
| å¯¼å‡ºå€¼å˜åŒ–             | å®æ—¶ç»‘å®šï¼ˆlive bindingï¼‰          | å€¼æ‹·è´ï¼ˆcopyï¼‰                    |
| é€‚ç”¨ç¯å¢ƒ              | æµè§ˆå™¨ & Node (ESM æ”¯æŒ)         | Node.js                      |
| æ˜¯å¦æ”¯æŒ tree-shaking | âœ… æ”¯æŒ                        | âŒ ä¸æ”¯æŒ                        |

---

## ğŸ’¡ å…«ã€Node.js ä¸­ä½¿ç”¨ ES Module

Node.jsï¼ˆv14+ï¼‰å¼€å§‹åŸç”Ÿæ”¯æŒ ES Moduleã€‚

### âœ… å¯ç”¨ ESM çš„æ–¹æ³•ï¼š

#### æ–¹æ³• 1ï¼šä¿®æ”¹ `package.json`

```json
{
  "type": "module"
}
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨ `.mjs` åç¼€

æ–‡ä»¶åæ”¹ä¸ºï¼š

```
app.mjs
```

---

### ğŸš« æ³¨æ„ï¼š

åœ¨ ESM ä¸­ï¼š

```js
// âŒ ä¸å¯ç”¨ï¼š
require();
module.exports;
__dirname;
__filename;

// âœ… å¯ç”¨ï¼š
import.meta.url;
```

å¦‚æœè¦è·å–è·¯å¾„ï¼š

```js
import path from 'path';
import { fileURLToPath } from 'url';
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
```

---

## ğŸ§­ ä¹ã€æµè§ˆå™¨ç¯å¢ƒä¸­çš„ä½¿ç”¨

åœ¨ HTML ä¸­ç›´æ¥ä½¿ç”¨ï¼š

```html
<script type="module">
  import { add } from './math.js';
  console.log(add(1, 2));
</script>
```

æˆ–è€…ï¼š

```html
<script type="module" src="./app.js"></script>
```

> æ¨¡å—é»˜è®¤æ˜¯ `defer` åŠ è½½ï¼ˆä¸ä¼šé˜»å¡æ¸²æŸ“ï¼‰ã€‚

---

## ğŸ”§ åã€æ··åˆä½¿ç”¨ï¼ˆCommonJS + ESMï¼‰

### ä» ESM å¯¼å…¥ CommonJSï¼š

```js
import pkg from './cjs-module.cjs';
```

### ä» CommonJS å¯¼å…¥ ESMï¼š

```js
(async () => {
  const mod = await import('./esm-module.mjs');
})();
```

---

æ˜¯å¦å¸Œæœ›æˆ‘æ¥ç€å†™ä¸€ä»½

> ğŸ§© **ã€ŒCommonJS â†” ESModule äº’è½¬å®æˆ˜æŒ‡å—ã€**
> åŒ…æ‹¬å¦‚ä½•å¿«é€ŸæŠŠä¸€ä»½æ—§çš„ `require/module.exports` é¡¹ç›®æ”¹é€ æˆ `import/export`ï¼Ÿ
